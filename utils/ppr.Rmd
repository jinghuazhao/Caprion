---
title: "Analysis of phase II Caprion proteomics data"
author:
- Jing Hua Zhao,..., Adam Buterworth
date: "`r Sys.Date()`"
toc: true
number_sections: true
output:
  pdf_document: default
  html_document: default
bibliography: ppr.bib
csl: nature-genetics.csl
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(bookdown)
library(knitr)
library(png)
library(tinytex)
```

The documentation provides the reationale and elementary results from the two-phase Caprion proteomics study.

Phase I (study code ZWK) included 196 samples and Phase II (study code ZYQ) contained 1,488 samples.

## Exploratory analysis

An undisclosed pattern was reported in @zyq but recovered through PCA.

The clustering based on PC1 and PC2 featured poorly with K-means but perfectly with model-based clustering, which 
agreed excellently with the two-class membership provided by the company.

## Association analysis

Association statistics were obtained according to model \@ref(eq:model).
$$
\begin{equation}
invnormal(protein) \sim covariates + genotypes (\#eq:model)
\end{equation}
$$
For phase II model, the covariates include sample classificaiton according to model-based clustering.

The genotypes were in .bgen format with MAF > 0.01 and the association analysis was furnished with PLINK v2 available on CSD3 through `module load plink/2.00-alpha`.

## Selection of sentinels

The sentinels were obtained via a distance-based iterative merging -- for a given p value cutoff the procedure involves several steps:

1. Obtain a list of genomewide significant variants and their (+/- 1Mb) flanking regions. For HLA region (build 37, chr6:25392021-33392022), only one variant is kept.
2. Identify non-overlapping regions.
3. Select the most significant variant in these regions as sentinels; in cases there are ties, keep only one of them.

Step 2 is implemented using `bedtools`. Step 3 is facilitaed with an R:

```r
  library(dplyr)
  sentinels <- merged_results %>%
               group_by(trait,Chrom,Start,End) %>%
               slice(which.min(P))
```

## Phase I and Phase II correlation

Genome-wide p values at both phases were used.

To improve the property of statistics involving p values, they are converted to their normal(0, 1) deviates ($z$) for calculation of correlations.

Without loss of generality, let $z$>0 (or $z$=$-z$ otherwise) and for a two-sided p value, we have 

$$\begin{equation}
p=\Phi(-z)+(1-\Phi(z)) = 2\Phi(-z) (\#eq:pvalue)
\end{equation}$$

due to symmetry, so $z=\Phi^{-1}(p/2)$ where $\Phi(.)$ is the cumulative distribution function.

We therefore have the R function `z <- function(p) -qnorm(p/2)`.

## Miami plots

This visually contrasts two vectors of p values emanating from the same chromosomal positions, and an example is given below.

The plot was produced with miamiplot() function in R/gap.

## Overlap of sentinels

Our focus here is on $10^{-5}$ and $5 \times 10^{-8}$.

# Files at CSD3

## Data

/rds/project/jmmh2/rds-jmmh2-projects/Caprion_proteomics/

## Analysis

pilot/ subdirectory of data.

Item           | I                   | II
---------------|---------------------|-------------------
Data           | data                | data2
PLINK2 results | bgen (1e-5, 5e-8)   | bgen2 (1e-5, 5e-8)

where sentinels from specific p value cutoff are in their own named directories, i.e., 1e-5, 5e-8.

# A summary

Item      |I/protein| II/protein
----------|---------|-----------
N         | 196     | 1488
----------|---------|-----------
Sentinels |
----------|---------|-----------
1e-5      |25766/987| 16298/982
----------|---------|-----------
5e-8      |226/203  | 192/178
----------|---------|-----------

Here phase II results were based on all data (_All, normalised log-intensities for every sample)[@zyq].

# A case study

The EPCR-PROC case study was reported earlier.

# Reflections

It is somewhat counterintuitive not to see more significant results from phase II although the sample size is seven fold larger. It is unclear if this is due to a systematic bias in the measurement.

It is possible to work on the piptides and/or also only those above limit of detection (_DR, normalised log-intensities for every sample with detection rate >10%).

```{r echo=FALSE, fig.cap="K-means clustering of phase II proteins"}
include_graphics("clustering-2020-0.png")
```

```{r echo=FALSE, fig.cap="Model-based clustering of phase II proteins"}
include_graphics("clustering-2020-1.png")
```

```{r echo=FALSE, fig.cap="P22626-ROA2 Miami plot"}
include_graphics("miamiplot/24-03-2021/P22626-ROA2-phase1-phase2.png")
```

# References

<div id="refs"></div>

---
nocite: |
@zyq
---

# (APPENDIX) Appendix {-}

# Correlation between p values and their difference

The idea is best illustrated with a toy example involving two vectors of p values (`p` and `pr`) below

```{r echo=TRUE}
# z=-1.96 correspond to a two-sided p=0.05
z <- function(p) -qnorm(p/2)
z(0.05)
p <- 1:10/10; p
pr <- 1:10/100; pr
cor(z(p),z(pr))
wilcox.test(p,pr,alternative="less",paired=TRUE)
```
where the correlation is obtained according to [0,1] and a nonparametric test of difference conducted. Note in particular the way the statistical significance was reported, for `pr` was generated an order of magnitude smaller than `p`.

# Information regarding the Miami plot above.

```{r echo=FALSE}
img_path <- "miamiplot/24-03-2021/P22626-ROA2-phase1-phase2.png"
img <- readPNG(img_path, native = TRUE, info = TRUE)
attr(img, "info")
```
---
references:
- id: zyq
  title: Summary Report Slides For: Biomarker Discovery Analysis of Human Plasma Using a NonTargeted LC-MS/MS Approach
  author:
  - caprion
  type: article-journal
  issued:
    year: 2020
    month: 9
---
